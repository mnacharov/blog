<!DOCTYPE html>
<html lang="ru_ru" prefix="og: http://ogp.me/ns#">
	<head>
		<link href="http://gmpg.org/xfn/11" rel="profile">
		<meta http-equiv="X-UA-Compatible" content="IE=edge">
		<meta http-equiv="content-type" content="text/html; charset=utf-8">

		<!-- Metadata -->
	<meta name="description" content="">
	<meta property="og:description" content="">
	<meta property="og:title" content="Решаем траблы с ssl в requests" />
	<meta property="og:type" content="article" />
	<meta property="og:url" content="./solving-issue-with-ssl-in-requests.html" />
		<meta property="og:image" content="./images/avatar.jpg" />

		<!-- Enable responsiveness on mobile devices-->
		<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1">

		<title>mnach</title>

		<!-- CSS -->
		<link href="//fonts.googleapis.com/" rel="dns-prefetch">
		<link href="//fonts.googleapis.com/css?family=Droid+Serif:400,700,400italic|Abril+Fatface|PT+Sans:400,400italic,700&amp;subset=latin,latin-ext" rel="stylesheet">

		<link rel="stylesheet" href="./theme/css/poole.css" />
		<link rel="stylesheet" href="./theme/css/hyde.css" />
		<link rel="stylesheet" href="./theme/css/syntax.css" />
			<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/fork-awesome@1.1.7/css/fork-awesome.min.css" crossorigin="anonymous">

		<!-- Feeds -->
<link href="https://www.mnacharov.ru/feeds/all.rss.xml" type="application/rss+xml" rel="alternate" title="mnach Full RSS Feed" />
<link href="https://www.mnacharov.ru/feeds/python.rss.xml" type="application/rss+xml" rel="alternate" title="mnach Categories RSS Feed" />

		<!-- Analytics -->
	</head>

	<body class="theme-base-0d">
<div class="sidebar">
	<div class="container sidebar-sticky">
		<div class="sidebar-about">

			<h1>
				<a href="/">
					<img class="profile-picture" src="./images/avatar.jpg">
					mnach
				</a>
			</h1>
			<p class="lead"></p>
			<p class="lead"> </p>
			<p></p>
		</div>
			<ul class="sidebar-nav">
					<li><a href="./pages/about.html">Об авторе</a></li>
			</ul>
		<nav class="sidebar-social">
					<a class="sidebar-social-item" href="https://github.com/mnacharov/" target="_blank">
						<i class="fa fa-GitHub"></i>
					</a>
			<a class="sidebar-social-item" href="https://www.mnacharov.ru/feeds/all.rss.xml">
				<i class="fa fa-rss"></i>
			</a>
		</nav>
	</div>
</div>		<div class="content container">
<div class="post">
	<h1 class="post-title">Решаем траблы с ssl в requests</h1>
	<span class="post-date">07/07/16</span>
	<p>Довольно необычное поведение обнаружил у python библиотеки
<a class="reference external" href="http://requests.readthedocs.io/en/master/">requests</a>
при работе с SSL-сертификатами. Если коротко:
&quot;requests не использует <a class="reference external" href="http://docs.python-requests.org/en/latest/user/advanced/#ca-certificates">системные сертификаты</a>&quot;</p>
<p>Как можно догадаться это приводит к сообщениям о не безопасном соединении,
тогда как система уже давно доверенняет данному сертификату.</p>
<div class="section" id="id2">
<h2>Проявления</h2>
<p>Итак, в каких случаях это может быть проблемой?
Например, Вы поддерживаете некий старый проект использующий эту библиотеку
чтобы обращаться к некому внешнему https ресурсу. Если ресурс поменяет
удостоверяющий центр(Certificate Authority - CA), то проект станет считать
ресурс небезопасными и выдавать примерно следующее:</p>
<div class="highlight"><pre><span></span><span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;/home/user/.pyenv/versions/3.3.6/envs/project-3.3.6/lib/python3.3/site-packages/requests/adapters.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">376</span><span class="p">,</span> <span class="ow">in</span> <span class="n">send</span>
    <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span>
  <span class="n">File</span> <span class="s2">&quot;/home/user/.pyenv/versions/3.3.6/envs/project-3.3.6/lib/python3.3/site-packages/requests/packages/urllib3/connectionpool.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">588</span><span class="p">,</span> <span class="ow">in</span> <span class="n">urlopen</span>
    <span class="k">raise</span> <span class="n">SSLError</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
<span class="n">requests</span><span class="o">.</span><span class="n">packages</span><span class="o">.</span><span class="n">urllib3</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span> <span class="p">[</span><span class="n">SSL</span><span class="p">:</span> <span class="n">CERTIFICATE_VERIFY_FAILED</span><span class="p">]</span> <span class="n">certificate</span> <span class="n">verify</span> <span class="n">failed</span> <span class="p">(</span><span class="n">_ssl</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">548</span><span class="p">)</span>

<span class="n">During</span> <span class="n">handling</span> <span class="n">of</span> <span class="n">the</span> <span class="n">above</span> <span class="n">exception</span><span class="p">,</span> <span class="n">another</span> <span class="n">exception</span> <span class="n">occurred</span><span class="p">:</span>

<span class="n">Traceback</span> <span class="p">(</span><span class="n">most</span> <span class="n">recent</span> <span class="n">call</span> <span class="n">last</span><span class="p">):</span>
  <span class="n">File</span> <span class="s2">&quot;/home/user/src/project/application/tests.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">38</span><span class="p">,</span> <span class="ow">in</span> <span class="n">test_get_token</span>
    <span class="n">token</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">auth_token_mixin</span><span class="o">.</span><span class="n">get_token</span><span class="p">()</span>
  <span class="o">....</span>
  <span class="n">File</span> <span class="s2">&quot;/home/user/.pyenv/versions/3.3.6/envs/project-3.3.6/lib/python3.3/site-packages/requests/adapters.py&quot;</span><span class="p">,</span> <span class="n">line</span> <span class="mi">447</span><span class="p">,</span> <span class="ow">in</span> <span class="n">send</span>
    <span class="k">raise</span> <span class="n">SSLError</span><span class="p">(</span><span class="n">e</span><span class="p">,</span> <span class="n">request</span><span class="o">=</span><span class="n">request</span><span class="p">)</span>
<span class="n">requests</span><span class="o">.</span><span class="n">exceptions</span><span class="o">.</span><span class="n">SSLError</span><span class="p">:</span> <span class="p">[</span><span class="n">SSL</span><span class="p">:</span> <span class="n">CERTIFICATE_VERIFY_FAILED</span><span class="p">]</span> <span class="n">certificate</span> <span class="n">verify</span> <span class="n">failed</span> <span class="p">(</span><span class="n">_ssl</span><span class="o">.</span><span class="n">c</span><span class="p">:</span><span class="mi">548</span><span class="p">)</span>
</pre></div>
<p>То-же самое будет, если вы решили выпустить свой корневой сертификат для внутренних
нужд. Не достаточно просто прописать Ваш корневой сертификат в системе, так как
библиотека смотрит не на систему, а на себя.</p>
</div>
<div class="section" id="id3">
<h2>Что делать?</h2>
<p>В первом случае придётся один раз обновить библиотеку requests до 2.4.0 и старше.
Начиная с этой версии она использует <a class="reference external" href="https://certifi.io/en/latest/">Certify</a>
для получения CA, таким образом в дальнейшем можно обновлять только её.</p>
<p>Во втором случае придётся установить переменную окружения <em>REQUESTS_CA_BUNDLE</em> в папку где хранятся системные корневые сертификаты, например в debian-системах</p>
<div class="highlight"><pre><span></span>user@pc ~$ <span class="nb">export</span> <span class="nv">REQUESTS_CA_BUNDLE</span><span class="o">=</span>/etc/ssl/certs/
</pre></div>
<p><strong>Спасибо за внимание</strong></p>
</div>

</div>
		</div>
	</body>
</html>